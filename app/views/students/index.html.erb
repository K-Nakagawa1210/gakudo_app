<div class="main-container text-center">

  <div class="back-button-area mb-4">
    <%= link_to "前のページに戻る", attendance_index_schools_path, class: "btn btn-outline-secondary btn-sm" %>
  </div>

  <div class="clock-display mb-4">
    🕒 <span id="current-time"></span>
  </div>

  <h2 class="school-title mb-4"><%= @school.school_name %> の児童</h2>

  <%= form_with url: attend_create_school_students_path(@school), method: :post, local: true, id: "attendance-form" do %>
    <% grouped_students = @students.group_by { |s| s.grade.level } %>

    <% grouped_students.sort.each do |grade_level, students| %>
      <div class="card mb-3 student-group-card">
        <div class="card-header bg-light fw-bold grade-header"><%= grade_level %>年生</div>
        <div class="card-body student-list">
          
          <div class="row row-cols-3 g-2"> 
            <% students.each do |student| %>
              <div class="col">
                <div class="student-button" 
                     data-student-id="<%= student.id %>"
                     data-bs-toggle="tooltip" data-bs-placement="top" title="未選択">
                  
                  <%= student.student_name %>
                  <%= check_box_tag "student_ids[]", student.id, false, class: "d-none" %>
                  
                </div>
              </div>
            <% end %>
          </div>
          
        </div>
      </div>
    <% end %>

    <div class="submit-buttons-area mt-5 mb-5">
      <%= button_tag "登園", type: "submit", name: "action_type", value: "attend", class: "btn btn-lg attend-btn me-3" %>
      <%= button_tag "帰宅", type: "submit", name: "action_type", value: "leave", class: "btn btn-lg leave-btn" %>
    </div>
  <% end %>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // 時刻表示の関数を修正 (日付と時刻の間にスペースを挿入)
  function updateTime() {
    const now = new Date();
    const datePart = now.toLocaleString('ja-JP', {
      year: 'numeric', month: '2-digit', day: '2-digit'
    });
    const timePart = now.toLocaleString('ja-JP', {
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    // innerHTMLを使用してスペース（&nbsp;）を挿入
    document.getElementById("current-time").innerHTML = `${datePart} &nbsp;&nbsp; ${timePart}`;
  }

  updateTime();
  setInterval(updateTime, 1000); 

  // 児童ボタンの選択ロジック
  document.querySelectorAll('.student-button').forEach(button => {
    button.addEventListener('click', () => {
      button.classList.toggle('selected');
      
      // 隠しチェックボックスの状態をトグル
      const checkbox = button.querySelector('input[type="checkbox"]');
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
      }
    });
  });
});
</script>